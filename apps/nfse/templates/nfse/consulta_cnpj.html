{% extends 'base.html' %}

{% block title %}Consulta CNPJ - AgentNFe{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Consulta CNPJ - Receita Federal</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'contabilidade:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Consulta CNPJ</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Card de Consulta -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-search me-2"></i>
                    Consultar CNPJ
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Consulte dados cadastrais de empresas diretamente na Receita Federal (via BrasilAPI).
                </p>

                <form method="post" id="formConsulta">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-8">
                            <label for="cnpj" class="form-label">CNPJ</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="cnpj" 
                                   name="cnpj" 
                                   placeholder="00.000.000/0000-00"
                                   value="{{ cnpj_pesquisado }}"
                                   maxlength="18"
                                   required>
                            <small class="form-text text-muted">Digite apenas os números ou com formatação</small>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" name="acao" value="consultar" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-search me-2"></i>Consultar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resultado da Consulta -->
        {% if dados %}
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle me-2"></i>
                    Dados Encontrados
                </h5>
                {% if dados.ja_cadastrado %}
                <span class="badge bg-light text-dark">
                    <i class="bi bi-database-check me-1"></i>Já cadastrado
                </span>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- Dados Principais -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3 text-primary">
                            <i class="bi bi-building me-2"></i>Dados Cadastrais
                        </h6>
                        <dl class="row">
                            <dt class="col-sm-3">CNPJ</dt>
                            <dd class="col-sm-9">
                                <code class="fs-6">{{ dados.cnpj_formatado }}</code>
                            </dd>

                            <dt class="col-sm-3">Razão Social</dt>
                            <dd class="col-sm-9"><strong>{{ dados.razao_social }}</strong></dd>

                            <dt class="col-sm-3">Nome Fantasia</dt>
                            <dd class="col-sm-9">{{ dados.nome_fantasia }}</dd>

                            <dt class="col-sm-3">Situação</dt>
                            <dd class="col-sm-9">
                                <span class="badge bg-info">{{ dados.situacao_cadastral }}</span>
                                {% if dados.data_situacao != '-' %}
                                <small class="text-muted ms-2">desde {{ dados.data_situacao }}</small>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-3">Natureza Jurídica</dt>
                            <dd class="col-sm-9">{{ dados.natureza_juridica }}</dd>

                            <dt class="col-sm-3">Porte</dt>
                            <dd class="col-sm-9">{{ dados.porte }}</dd>

                            <dt class="col-sm-3">Capital Social</dt>
                            <dd class="col-sm-9">
                                {% if dados.capital_social != '-' %}
                                R$ {{ dados.capital_social }}
                                {% else %}
                                -
                                {% endif %}
                            </dd>

                            <dt class="col-sm-3">Data Abertura</dt>
                            <dd class="col-sm-9">{{ dados.data_abertura }}</dd>

                            <dt class="col-sm-3">CNAE Principal</dt>
                            <dd class="col-sm-9">{{ dados.cnae_principal }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Endereço -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3 text-primary">
                            <i class="bi bi-geo-alt me-2"></i>Endereço
                        </h6>
                        <dl class="row">
                            <dt class="col-sm-3">Logradouro</dt>
                            <dd class="col-sm-9">{{ dados.tipo }}, {{ dados.numero }}</dd>

                            <dt class="col-sm-3">Complemento</dt>
                            <dd class="col-sm-9">{{ dados.complemento }}</dd>

                            <dt class="col-sm-3">Bairro</dt>
                            <dd class="col-sm-9">{{ dados.bairro }}</dd>

                            <dt class="col-sm-3">CEP</dt>
                            <dd class="col-sm-9">{{ dados.cep }}</dd>

                            <dt class="col-sm-3">Cidade/UF</dt>
                            <dd class="col-sm-9">
                                {{ dados.municipio }} - <span class="badge bg-secondary">{{ dados.uf }}</span>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Contato -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3 text-primary">
                            <i class="bi bi-telephone me-2"></i>Contato
                        </h6>
                        <dl class="row">
                            <dt class="col-sm-3">E-mail</dt>
                            <dd class="col-sm-9">{{ dados.email }}</dd>

                            <dt class="col-sm-3">Telefone</dt>
                            <dd class="col-sm-9">{{ dados.telefone }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Ações -->
                <div class="d-flex gap-2 justify-content-end border-top pt-3">
                    <a href="{% url 'nfse:consulta_cnpj' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise me-2"></i>Nova Consulta
                    </a>
                    
                    {% if not dados.ja_cadastrado %}
                    <form method="post" class="d-inline" onsubmit="return confirm('Confirma a adição deste cliente?');">
                        {% csrf_token %}
                        <input type="hidden" name="cnpj" value="{{ dados.cnpj }}">
                        <button type="submit" name="acao" value="adicionar" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Adicionar Cliente Tomador
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'nfse:tomador_list' %}?cnpj={{ dados.cnpj }}" class="btn btn-primary">
                        <i class="bi bi-eye me-2"></i>Ver Cliente Cadastrado
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Informações -->
        <div class="alert alert-info mt-4">
            <h6 class="alert-heading">
                <i class="bi bi-info-circle me-2"></i>Informações
            </h6>
            <ul class="mb-0">
                <li>Os dados são consultados diretamente na base da Receita Federal via BrasilAPI</li>
                <li>Após consultar, você pode adicionar a empresa como Cliente Tomador</li>
                <li>Se o cliente já estiver cadastrado, ele não será duplicado</li>
                <li>Consulta gratuita e sem limite de requisições</li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Formatação automática de CNPJ
document.getElementById('cnpj').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 14) {
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
        e.target.value = value;
    }
});

// Auto-focus no campo CNPJ
document.addEventListener('DOMContentLoaded', function() {
    {% if not dados %}
    document.getElementById('cnpj').focus();
    {% endif %}
});

// Validação básica antes de enviar
document.getElementById('formConsulta').addEventListener('submit', function(e) {
    const cnpj = document.getElementById('cnpj').value.replace(/\D/g, '');
    if (cnpj.length !== 14) {
        e.preventDefault();
        alert('CNPJ deve conter 14 dígitos!');
        return false;
    }
});
</script>
{% endblock %}
